# Module Federation å®éªŒä»“åº“

## ğŸ“ ç›®å½•è¯´æ˜

### åº”ç”¨é¡¹ç›®
- **app-mf-cra**: ç”± `npx create-react-app my-app` äº§ç”Ÿçš„åŸºç¡€é¡¹ç›®ï¼Œå¹¶æ‰§è¡Œ `pnpm eject` çš„ç»“æœï¼Œé¡¹ç›®ä»æœªæµ‹è¯•
- **app-mf-rsbuild**: ç”±[Module Federation å¿«é€Ÿä¸Šæ‰‹](https://module-federation.io/zh/guide/start/quick-start.html)äº§ç”Ÿï¼Œå…·ä½“æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¹¶é€‰æ‹© application æ—¶äº§ç”Ÿ
  ```bash
  pnpm create module-federation@latest
  ```
- **app-mf-rspack**: æ ¹æ® [rspack æ–‡æ¡£](https://rspack.dev/zh/guide/start/quick-start#%E4%BD%BF%E7%94%A8-rspack-cli) äº§ç”Ÿï¼Œä»æœªä½¿ç”¨/æµ‹è¯•
- **app-mf-vite**: ç”± `pnpm create viet` äº§ç”ŸåŸºæœ¬é¡¹ç›®ï¼Œå¹¶æ ¹æ®[Module Federation vite plugin](https://module-federation.io/zh/guide/basic/vite.html)ç»“åˆ`git@github.com:gioboa/react-microfrontend-demo.git`,`git@github.com:module-federation/module-federation-examples.git` ä»¥åŠ `git@github.com:module-federation/vite.git` äº§ç”Ÿ
- **app-mf-webpack**: ç”± AI ç”Ÿæˆï¼Œå¯ä»¥è¿è¡Œï¼Œç»“åˆ [module-federation-plugin](https://webpack.docschina.org/plugins/module-federation-plugin/) æ–‡æ¡£äº§ç”Ÿ

### åº“é¡¹ç›®
- **lib-mf-rsbuild**: æ ¹æ®[rsbuild å¿«é€Ÿä¸Šæ‰‹](https://rsbuild.dev/zh/guide/start/quick-start)ï¼Œå¹¶[æ‰‹åŠ¨æ­å»º](https://module-federation.io/zh/guide/basic/rsbuild.html)çš„ Module Federation é¡¹ç›®
- **lib-mf-rslib**: ç”±[Module Federation å¿«é€Ÿä¸Šæ‰‹](https://module-federation.io/zh/guide/start/quick-start.html)ä»¥ä¸‹å‘½ä»¤ï¼Œå¹¶é€‰æ‹©`lib`æ—¶äº§ç”Ÿ
- **lib-mf-vite**: ç”± `pnpm create viet` äº§ç”ŸåŸºæœ¬é¡¹ç›®ï¼Œå¹¶æ ¹æ®[Module Federation vite plugin](https://module-federation.io/zh/guide/basic/vite.html)ç»“åˆäº§ç”Ÿ
- **lib-mf-webpack**: ç”± AI ç”Ÿæˆï¼Œå¯ä»¥è¿è¡Œï¼Œç»“åˆ [module-federation-plugin](https://webpack.docschina.org/plugins/module-federation-plugin/) æ–‡æ¡£äº§ç”Ÿï¼Œä½†å…¶äº§ç”Ÿçš„ mf ä¸èƒ½è¢«å…¶ä»–é¡¹ç›®ä½¿ç”¨

## âš ï¸ ä¸¥é‡ Bug

1. ~~ç”± `pnpm create module-federation@latest` å‘½ä»¤äº§ç”Ÿçš„ `åˆå§‹é¡¹ç›®` ä¾èµ–ç›¸äº’ä¸åŒ¹é…, å¯¼è‡´ `å‘½ä»¤` åˆ›å»ºçš„é¡¹ç›®ä¸èƒ½ç›´æ¥ä½¿ç”¨, é™¤é `å…¨é‡` `update` ä¸€æ¬¡~~ (å®˜æ–¹å·²ä¿®å¤)
2. mf vite plugin å’Œ åŸºäº rspack çš„æ’ä»¶ä½¿ç”¨ä½“éªŒå®Œå…¨ä¸ä¸€è‡´: ä¸»è¦ä½“ç°åœ¨ ts , å¦‚æœæŒ‰ç…§ webpack æ¨¡å—è”é‚¦æ’ä»¶çš„ç”¨æ³•, åˆ™ä¸ä¼šå‡ºç°å¤ªå¤§çš„é—®é¢˜


## ä½¿ç”¨æ³¨æ„äº‹é¡¹

remote/expose çš„é…ç½® key ä¸èƒ½åŒ…å« `-` (é»˜è®¤ä¸ºvaræ ¼å¼å¯¼è‡´çš„) ï¼Œå¦åˆ™åœ¨åŸºäº rslib çš„é¡¹ç›®è‡ªåŠ¨æ‰“åŒ…æ—¶ä¼šæŠ¥é”™å¹¶æ— æ³•æˆåŠŸæ„å»º, å°±ç®—æ„å»ºæˆåŠŸå¯èƒ½ä¹Ÿæ— æ³•åœ¨å¼•ç”¨ç«¯æ­£å¸¸ä½¿ç”¨,å› æ­¤æœ€å¥½ä¸è¦åŒ…å«ç¨‹åºä¸­ä½¿ç”¨çš„å¸¸è§è¿ç®—ç¬¦, æœ€å¥½å°±æ˜¯çº¯å­—æ¯

## æœ¬ä»“åº“é¢„è§ˆæ–¹æ³•

è¦æƒ³æ­£å¸¸å¯åŠ¨æœ¬ä»“åº“ä¸­çš„æ¡ˆä¾‹, å¹¶é¢„è§ˆæµ‹è¯•, éœ€è¦å…ˆå¯åŠ¨ä»¥ `libå¼€å¤´` çš„ `é¢„è§ˆmfæœåŠ¡å™¨`

ç„¶åå†å¯åŠ¨ `appå¼€å¤´` çš„ å¼•ç”¨ `mf(æ¨¡å—è”é‚¦)`

å…¶ä¸­ä»¥ä¸‹ç›®å½•çš„åº”ç”¨å¹¶æœªæ”¯æŒé¢„è§ˆ,éœ€è¦è‡ªè¡Œé…ç½®

- app-mf-cra
- app-mf-rspack

ä¸‹æ–‡ä»‹ç»çš„è¿è¡Œå‘½ä»¤, æ˜¯ä»¥å‡å®šé¢„è§ˆç”¨æˆ·æ‰§è¡Œå‘½ä»¤çš„è·¯å¾„ä¸ºé¡¹ç›®æ ¹ç›®å½•çš„å‰æçš„

### å¯åŠ¨libå¼€å¤´çš„é¡¹ç›®( mf æœåŠ¡)


1. lib-mf-rsbuild
  
  ```bash
  pnpm --filter rsbuild_mf_components dev
  ```
2. lib-mf-rslib
  ```bash
  pnpm --filter lib-mf-rslib mf-dev
  ```
  å¦å¤–,å¦‚æœæƒ³å°è¯•ä¿®æ”¹å¹¶äº«å—åˆ°å®æ—¶çš„ç¼–è¯‘ä¾¿åˆ©, è¿˜éœ€è¦å¯åŠ¨
  ```bash
  pnpm --filter lib-mf-rslib dev
  ```
3. lib-mf-vite
  ```bash
  pnpm --filter app-mf-vite dev
  ```
4. lib-mf-webpack
  ```bash
  pnpm --filter lib-mf-webpack start
  ```

### å¯åŠ¨appé¢„è§ˆ mf æ•ˆæœ

1. app-mf-rsbuild
  ```bash
  pnpm --filter app_mf_rsbuild dev
  ```

2. app-mf-vite
  ```bash
  pnpm --filter app-mf-vite dev
  ```
3. app-mf-webpack
  ```bash
  pnpm --filter app-mf-webpack start
  ```


## ğŸ“‹ é¡¹ç›®è¯´æ˜

### app-mf-cra
create react app ä»æœªæµ‹è¯•

### app-mf-rsbuild
ä½¿ç”¨ rsbuild åˆ›å»ºçš„åº”ç”¨

è¿è¡Œåœ°å€ï¼š`http://localhost:4010/`

#### å¯åŠ¨é¢„è§ˆ
```bash
pnpm run dev
```

#### æµ‹è¯•ç»“æœ
- âœ… ä½¿ç”¨ `rslib` `mf-manifest` (4000ç«¯å£) åè®®æ­£å¸¸ä½¿ç”¨
- âœ… ä½¿ç”¨ `rsbuild` `mf-manifest`(4070ç«¯å£) åè®®æ­£å¸¸ä½¿ç”¨
- âœ… ä½¿ç”¨ `rslib` `remoteEntry.js`(4000ç«¯å£) è¿œç¨‹æ–‡ä»¶æŠ¥é”™
  ```text
  index.cjs.cjs:21  Uncaught (in promise) Error: [ Federation Runtime ]: remoteEntryExports is undefined 
  {
    "alias": "provider",
    "name": "lib-mf-rslib",
    "entry": "http://localhost:4000/mf_provider.js",
    "externalType": "script",
    "shareScope": "default",
    "type": "global",
    "entryGlobalName": "lib-mf-rslib"
  }
  while loading "." from webpack/container/reference/provider
  ```
  å¯¼å…¥åç§°é”™è¯¯
- âœ… ä½¿ç”¨ `rsbuild` `remoteEntry.js` (4070ç«¯å£) è¿œç¨‹æ–‡ä»¶æ­£å¸¸ä½¿ç”¨
- âœ… ä½¿ç”¨ `webpack` `remoteEntry.js` (4080ç«¯å£) è¿œç¨‹æ–‡ä»¶æŠ¥é”™
  ```text
  remoteEntry.js:163 [webpack-dev-server] Server started: Hot Module Replacement enabled, Live Reloading enabled, Progress disabled, Overlay enabled.
  remoteEntry.js:326 [HMR] Waiting for update signal from WDS...
  container_entry:12  Uncaught (in promise) Error: Module "." does not exist in container.
  while loading "." from webpack/container/reference/provider
  ```
  lib_mf_webpack æ‰“åŒ…å¯¼å‡ºé”™è¯¯,å¦‚æœè¦ä½¿ç”¨webpack çš„ lib éœ€è¦å…³é—­  shareStrategy é€‰é¡¹,å…³é—­shareStrategy å¯èƒ½å¯¼è‡´å¼•ç”¨ rslib mf å‡ºç°é”™è¯¯

- [ ] ä½¿ç”¨ `vite` `remoteEntry.js` (4050) è¿œç¨‹æ–‡ä»¶æŠ¥é”™
  ```text
  [ Federation Runtime ]: remoteEntryExports is undefined 
  {
    "alias": "vite_mf_components",
    "name": "vite_mf_components",
    "entry": "http://localhost:4060/remoteEntry.js",
    "externalType": "script",
    "shareScope": "default",
    "type": "global",
    "entryGlobalName": "vite_mf_components"
  }
  while loading "." from webpack/container/reference/vite_mf_components
  Error: [ Federation Runtime ]: remoteEntryExports is undefined 
  {
    "alias": "vite_mf_components",
    "name": "vite_mf_components",
    "entry": "http://localhost:4060/remoteEntry.js",
    "externalType": "script",
    "shareScope": "default",
    "type": "global",
    "entryGlobalName": "vite_mf_components"
  }
    at error (http://localhost:4010/static/js/vendors-_module-federation_runtime_rspack_js_data_text_javascript_import___module_federation_-ffb8fe.js:688:11)
    at assert (http://localhost:4010/static/js/vendors-_module-federation_runtime_rspack_js_data_text_javascript_import___module_federation_-ffb8fe.js:680:9)
    at Module.getEntry (http://localhost:4010/static/js/vendors-_module-federation_runtime_rspack_js_data_text_javascript_import___module_federation_-ffb8fe.js:1868:9)
    at async Module.get (http://localhost:4010/static/js/vendors-_module-federation_runtime_rspack_js_data_text_javascript_import___module_federation_-ffb8fe.js:1878:36)
    at async RemoteHandler.loadRemote (http://localhost:4010/static/js/vendors-_module-federation_runtime_rspack_js_data_text_javascript_import___module_federation_-ffb8fe.js:3232:37)
    at async Promise.all (index 4)
    at async Promise.all (index 2)
  ```
- [x] ä½¿ç”¨ `vite` `mf-manifest` (4060) è¿œç¨‹æ–‡ä»¶æŠ¥é”™ (å·²ä¿®å¤, vite æ‰“åŒ…é…ç½®é—®é¢˜)

### app-mf-rspack
åŸºäº `rspack` åˆ›å»ºçš„åº”ç”¨ï¼Œä»æœªæµ‹è¯•

### app-mf-vite
åŸºäº vite åˆ›å»ºçš„åº”ç”¨

#### å¯åŠ¨å¼€å‘é¢„è§ˆ
```bash
pnpm run dev
```

è¿è¡Œåœ°å€ï¼š`http://localhost:5173/`

#### æµ‹è¯•ç»“æœ
- âœ… å¯¹ rslib mf-manifest (4000ç«¯å£) åè®®æ­£å¸¸ä½¿ç”¨
- âœ… å¯¹ rslib mf_provider.js (4000ç«¯å£) è¿œç¨‹æ–‡ä»¶æ­£å¸¸ä½¿ç”¨
- âœ… å¯¹ rsbuild mf-manifest (4070ç«¯å£) åè®®æ­£å¸¸ä½¿ç”¨
- âœ… å¯¹ rsbuild remoteEntry.js (4070) è¿œç¨‹æ–‡ä»¶æ­£å¸¸ä½¿ç”¨
- âœ… ä½¿ç”¨ webpack remoteEntry.js (4080) è¿œç¨‹æ–‡ä»¶æŠ¥é”™(_ç°å·²ä¿®å¤,webpack é…ç½®æ–‡ä»¶é”™è¯¯_)
  ```text
  remoteEntry.js:163 [webpack-dev-server] Server started: Hot Module Replacement enabled, Live Reloading enabled, Progress disabled, Overlay enabled.
  remoteEntry.js:326 [HMR] Waiting for update signal from WDS...
  container_entry:12  Uncaught Error: Module "." does not exist in container.
  ```
- âœ… å¯¹ vite mf-manifest (4050) åè®®æ— æ³•è§£æ (å·²ä¿®å¤,vite æ‰“åŒ…é—®é¢˜)
- âŒ å¯¹ vite remoteEntry.js (4050) æŠ¥é”™
  ```text
  [ Federation Runtime ]: remoteEntryExports is undefined 
  {
    "entryGlobalName": "http://localhost:4050/remoteEntry.js",
    "name": "vitemfc",
    "type": "var",
    "entry": "http://localhost:4050/remoteEntry.js",
    "shareScope": "default"
  }
  Error: [ Federation Runtime ]: remoteEntryExports is undefined 
  {
    "entryGlobalName": "http://localhost:4050/remoteEntry.js",
    "name": "vitemfc",
    "type": "var",
    "entry": "http://localhost:4050/remoteEntry.js",
    "shareScope": "default"
  }
    at error2 (http://localhost:5173/node_modules/.vite/deps/chunk-MQ6423JS.js?v=85b979db:1187:13)
    at assert2 (http://localhost:5173/node_modules/.vite/deps/chunk-MQ6423JS.js?v=85b979db:1179:9)
    at Module.getEntry (http://localhost:5173/node_modules/.vite/deps/chunk-MQ6423JS.js?v=85b979db:2299:9)
    at async Module.get (http://localhost:5173/node_modules/.vite/deps/chunk-MQ6423JS.js?v=85b979db:2309:36)
    at async RemoteHandler.loadRemote (http://localhost:5173/node_modules/.vite/deps/chunk-MQ6423JS.js?v=85b979db:3582:35)
    at async http://localhost:5173/node_modules/.vite/deps/vitemfc.js?v=85b979db:25:49
  ```

**viteæ’ä»¶ä½¿ç”¨æ³¨æ„äº‹é¡¹**

è¯¦è§ `vite.config.ts` æ³¨é‡Š


### app-mf-webpack
åŸºäº webpack åˆ›å»ºçš„ app

#### è¿è¡Œé¢„è§ˆ
```bash
pnpm run start
```

é¢„è§ˆåœ°å€ï¼š`http://localhost:4090/`

#### æµ‹è¯•ç»“æœ
- âœ… æ‹‰å– rslib mf_provider.js æ­£å¸¸è¿è¡Œ
- âœ… rsbuild remoteEntry.js æ­£å¸¸è¿è¡Œ
- âœ… webpack remoteEntry.js æŠ¥é”™(_å·²ä¿®å¤,lib-mf-webpack é…ç½®é”™è¯¯_)
  ```text
  VM235 index.js:485 [webpack-dev-server] Server started: Hot Module Replacement enabled, Live Reloading enabled, Progress disabled, Overlay enabled.
  VM228 log.js:39 [HMR] Waiting for update signal from WDS...
  remoteEntry.js:163 [webpack-dev-server] Server started: Hot Module Replacement enabled, Live Reloading enabled, Progress disabled, Overlay enabled.
  remoteEntry.js:326 [HMR] Waiting for update signal from WDS...
  container_entry:12  Uncaught (in promise) Error: Module "." does not exist in container.
  while loading "." from webpack/container/reference/provider
  ```
- [ ] vite remoteEntry.js æŠ¥é”™
  ```text
  ERROR
  Script error.
      at handleError (webpack://app-mf-webpack/../node_modules/.pnpm/webpack-dev-server@4.15.2_webpack-cli@5.1.4_webpack@5.99.8/node_modules/webpack-dev-server/client/overlay.js?:251:58)
      at eval (webpack://app-mf-webpack/../node_modules/.pnpm/webpack-dev-server@4.15.2_webpack-cli@5.1.4_webpack@5.99.8/node_modules/webpack-dev-server/client/overlay.js?:270:7)
  ERROR
  Loading script failed.
  (missing: http://localhost:4050/remoteEntry.js)
  while loading "." from webpack/container/reference/provider
  ScriptExternalLoadError
      at webpack/container/reference/provider (http://localhost:4090/main.js:377:25)
      at __webpack_require__ (http://localhost:4090/main.js:417:32)
      at initExternal (http://localhost:4090/main.js:703:28)
      at __webpack_require__.I (http://localhost:4090/main.js:716:15)
      at http://localhost:4090/main.js:1213:47
      at webpack/sharing/consume/default/react/react (http://localhost:4090/main.js:1264:67)
      at __webpack_require__.m.<computed> (http://localhost:4090/main.js:1273:54)
      at __webpack_require__ (http://localhost:4090/main.js:417:32)
      at fn (http://localhost:4090/main.js:787:21)
      at eval (webpack://app-mf-webpack/./src/index.tsx?:2:63)
  ERROR
  Loading script failed.
  (missing: http://localhost:4050/remoteEntry.js)
  while loading "." from webpack/container/reference/provider
  ScriptExternalLoadError
      at webpack/container/reference/provider (http://localhost:4090/main.js:377:25)
      at __webpack_require__ (http://localhost:4090/main.js:417:32)
      at initExternal (http://localhost:4090/main.js:703:28)
      at __webpack_require__.I (http://localhost:4090/main.js:716:15)
      at http://localhost:4090/main.js:1213:47
      at webpack/sharing/consume/default/react/react (http://localhost:4090/main.js:1264:67)
      at __webpack_require__.m.<computed> (http://localhost:4090/main.js:1273:54)
      at __webpack_require__ (http://localhost:4090/main.js:417:32)
      at fn (http://localhost:4090/main.js:787:21)
      at eval (webpack://app-mf-webpack/./src/index.tsx?:2:63)
  ERROR
  Loading script failed.
  (missing: http://localhost:4050/remoteEntry.js)
  while loading "." from webpack/container/reference/provider
  ScriptExternalLoadError
      at webpack/container/reference/provider (http://localhost:4090/main.js:377:25)
      at __webpack_require__ (http://localhost:4090/main.js:417:32)
      at initExternal (http://localhost:4090/main.js:703:28)
      at __webpack_require__.I (http://localhost:4090/main.js:716:15)
      at http://localhost:4090/main.js:1213:47
      at webpack/sharing/consume/default/react/react (http://localhost:4090/main.js:1264:67)
      at __webpack_require__.m.<computed> (http://localhost:4090/main.js:1273:54)
      at __webpack_require__ (http://localhost:4090/main.js:417:32)
      at fn (http://localhost:4090/main.js:787:21)
      at eval (webpack://app-mf-webpack/./src/index.tsx?:2:63)
  ```
  

### lib-mf-rsbuild
åŸºäº `rsbuild` çš„æ¨¡å—è”é‚¦é¡¹ç›®

#### è¿è¡Œå‘½ä»¤
```bash
pnpm run dev
```

#### åŸºæœ¬ä¿¡æ¯
1. åŸºäº rsbuild åˆ›å»ºçš„æ¨¡å—è”é‚¦è¿œç¨‹æ¨¡å—é¡¹ç›®
2. ä½¿ç”¨æ’ä»¶ `@module-federation/rsbuild-plugin` æ„å»º
3. è¿è¡Œç«¯å£ `4070`

#### å¯¼å‡ºæ¨¡å—
æ¨¡å—åç§°ï¼š`rsbuild_mf_components`

1. åè®®ï¼šhttp://localhost:4070/mf-manifest.json
2. è„šæœ¬ï¼šhttp://localhost:4070/remoteEntry.js

### lib-mf-rslib

#### è¿è¡Œå‘½ä»¤
å®æ—¶ç¼–è¯‘ï¼š
```bash
pnpm run dev
```

è¿è¡Œé¢„è§ˆæœåŠ¡å™¨ï¼Œæš´éœ²è¿œç¨‹æ¨¡å—ï¼ˆè¿è¡Œæ¨¡å—è”é‚¦ï¼‰ï¼š
```bash
pnpm run mf-dev
```

#### åŸºæœ¬ä¿¡æ¯
1. åŸºäº rsbuild åˆ›å»ºçš„æ¨¡å—è”é‚¦è¿œç¨‹æ¨¡å—é¡¹ç›®
2. ä½¿ç”¨æ’ä»¶ `@module-federation/rsbuild-plugin` æ„å»º
3. è¿è¡Œç«¯å£ 4000

#### å¯¼å‡ºæ¨¡å—
æ¨¡å—åç§°ï¼š`mf_provider`

1. åè®®ï¼šhttp://localhost:4000/mf-manifest.json
2. è„šæœ¬ï¼šhttp://localhost:4000/mf_provider.js

### lib-mf-vite
ä½¿ç”¨ vite æ„å»ºçš„æ¨¡å—è”é‚¦åº”ç”¨

#### è¿è¡Œå‘½ä»¤
è¿è¡Œé¢„è§ˆï¼Œå¹¶æš´éœ²æ¨¡å—è”é‚¦ï¼š
```bash
pnpm run dev
```

#### åŸºæœ¬ä¿¡æ¯
1. åŸºäº vitejs åˆ›å»ºçš„æ¨¡å—è”é‚¦è¿œç¨‹æ¨¡å—é¡¹ç›®
2. ä½¿ç”¨æ’ä»¶ `@module-federation/vite` æ„å»º
3. å¼€å‘æœåŠ¡å™¨è¿è¡Œç«¯å£ 4050
4. é¢„è§ˆæœåŠ¡å™¨è¿è¡Œç«¯å£ 4060

#### å¯¼å‡ºæ¨¡å—
æ¨¡å—åç§°ï¼š`vite_mf_components`

1. åè®®ï¼šhttp://localhost:4050/mf-manifest.json
2. è„šæœ¬ï¼šhttp://localhost:4050/remoteEntry.js

### lib-mf-webpack
åŸºäº webpack æ„å»ºçš„æ¨¡å—è”é‚¦

#### è¿è¡Œé¢„è§ˆ
```bash
pnpm run start
```

#### åŸºæœ¬ä¿¡æ¯
1. åŸºäº webpack åˆ›å»ºçš„æ¨¡å—è”é‚¦è¿œç¨‹æ¨¡å—é¡¹ç›®
2. ä½¿ç”¨æ’ä»¶ webpack å†…ç½®æ¨¡å—è”é‚¦æ’ä»¶ `webpack/container/ModuleFederationPlugin` æ„å»º
3. é¢„è§ˆæœåŠ¡å™¨è¿è¡Œç«¯å£ 4080

#### å¯¼å‡ºæ¨¡å—
æ¨¡å—åç§°ï¼š`remote_mf_webpack`     

å­åŒ…: app

1. è„šæœ¬ï¼šhttp://localhost:4080/remoteEntry.js





